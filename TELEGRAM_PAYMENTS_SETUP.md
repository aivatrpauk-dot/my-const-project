# Настройка платежей через Telegram Bot API

## Шаг 1: Получение Payment Provider Token

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/mybots`
3. Выберите вашего бота `@wb_market_analytics_bot`
4. Нажмите "Payments"
5. Выберите платежного провайдера (рекомендуется ЮKassa для России)
6. Следуйте инструкциям для настройки провайдера
7. Скопируйте полученный Payment Provider Token

## Шаг 2: Настройка конфигурации

1. Создайте файл `.env` в корневой папке проекта:

```env
# Telegram Bot Token
BOT_TOKEN=8240807315:AAGj0vTPsia2vW4baFku7qsuy5My0qLl4Rc

# Tinkoff Kassa Settings
TINKOFF_TERMINAL_KEY=1749885008651
TINKOFF_PASSWORD=YBla2Zf$iQYwWuSU

# Telegram Payment Provider Token
TELEGRAM_PAYMENT_PROVIDER_TOKEN=your_telegram_payment_provider_token_here
TELEGRAM_PAYMENT_CURRENCY=RUB
```

2. Замените `your_telegram_payment_provider_token_here` на полученный токен

## Шаг 3: Настройка ЮKassa (рекомендуется для России)

### Для ЮKassa:

1. Зарегистрируйтесь на [ЮKassa](https://yookassa.ru/)
2. Создайте магазин в личном кабинете
3. Получите Shop ID и Secret Key
4. В @BotFather при настройке платежей выберите "ЮKassa"
5. Введите Shop ID и Secret Key

### Альтернативные провайдеры:

- **Stripe** - для международных платежей
- **Sberbank** - для России
- **Tinkoff** - для России

## Шаг 4: Тестирование

1. Запустите бота
2. Перейдите в меню подписки
3. Выберите "Telegram Payments"
4. Выберите тариф (299₽/месяц)
5. Проведите тестовый платеж

## Структура платежей

### Тарифы:
- **1 месяц** - 299₽
- **Пробный период** - 3 дня бесплатно

### Статусы платежей:
- `PENDING` - Ожидает оплаты
- `SUCCESS` - Оплачен
- `FAILED` - Ошибка оплаты
- `CANCELLED` - Отменен

## Обработка платежей

### Успешный платеж:
1. Пользователь оплачивает через Telegram
2. Telegram отправляет уведомление боту
3. Бот активирует подписку пользователя
4. Пользователь получает подтверждение

### Ошибка платежа:
1. Пользователь получает уведомление об ошибке
2. Платеж остается в статусе `PENDING`
3. Пользователь может попробовать снова

## Безопасность

- Все платежи обрабатываются через официальные API Telegram
- Токены хранятся в переменных окружения
- Платежи логируются в базе данных
- Поддерживается возврат средств через провайдера

## Поддержка

При возникновении проблем:

1. Проверьте правильность Payment Provider Token
2. Убедитесь, что провайдер настроен корректно
3. Проверьте логи бота на наличие ошибок
4. Обратитесь в поддержку провайдера платежей

## Дополнительные настройки

### Валюты:
- `RUB` - российский рубль
- `USD` - доллар США
- `EUR` - евро

### Настройка в коде:
```python
# В tg_bot/config.py
@dataclass
class TelegramPayConfig:
    provider_token: str
    currency: str = "RUB"
```

## Миграция базы данных

При первом запуске с новой системой платежей:

1. База данных автоматически обновится
2. Старые платежи останутся совместимыми
3. Новые платежи будут использовать обновленную структуру

## Мониторинг

Для мониторинга платежей используйте:

```sql
-- Все платежи
SELECT * FROM payments WHERE payment_method = 'telegram';

-- Успешные платежи за сегодня
SELECT * FROM payments 
WHERE payment_method = 'telegram' 
AND status = 'SUCCESS' 
AND DATE(created_at) = DATE('now');
``` 